#!/bin/bash
#
# Usage:
#   rlaunch OPTIONS [QEMU_ARGS]
# Options:
#   -h HOST_NAME    host name
#   -b BUILD_PATH   build folder on host
#   -i IMAGE_PATH   image folder on host
#   -m QEMU_MEMORY  qemu memory
#   -t TYPE         qemu type
#                     kvm      kvm
#                     kvm-cp   kvm with a copy of disk image
#                     qemu     qemu
#                     s2e      s2e-qemu (with QEMU_ARGS)
#                     s2e-gdb  s2e-qemu in GDB (with QEMU_ARGS)
# Example:
#   rlaunch -h dslab-vader1.epfl.ch -b '~/workspace/build' -i '~/workspace/image' -m 1G -t s2e
#

set -e -u

#
#
#

# telnet port for qemu monitor
QPORT=4444

# VNC display number
VNC=7

OPTIND=1
while getopts "h:b:i:m:t:" opt; do
  case "$opt" in
    h)
      REMOTE_HOST=${OPTARG}
      ;;
    b)
      REMOTE_BUILD=${OPTARG}
      ;;
    i)
      REMOTE_IMAGE=${OPTARG}
      ;;
    m)
      QEMU_MEMORY=${OPTARG}
      ;;
    t)
      TYPE=${OPTARG}
      ;;
  esac
done
shift $((OPTIND-1))

#
#
#

# set up environment
CMD=
CMD+="export IMAGE=${REMOTE_IMAGE}          &&"
CMD+="export BUILD=${REMOTE_BUILD}          &&"
CMD+="export S2E_PAYLOAD=\${IMAGE}          &&"
CMD+="export WINDOWS_FS=\${IMAGE}/guestfs   &&"
CMD+="mkdir -p \${IMAGE}/out                &&"
CMD+="cd \${IMAGE}/out                      &&"

case ${TYPE} in
	kvm|kvm-cp)
		CMD+=" qemu-system-i386"
		CMD+=" -enable-kvm"
		CMD+=" -net nic,model=pcnet -net user"
		if [ ${TYPE} == 'kvm' ]; then
			CMD+=" -drive file=\${IMAGE}/image.raw.s2e"
		else
			CMD+=" -drive file=\${IMAGE}/image.raw.s2e.copy"
		fi
		;;
	qemu)
		CMD+=" \${BUILD}/qemu-release/i386-softmmu/qemu-system-i386"
		CMD+=" -drive file=\${IMAGE}/image.raw.s2e,cache=writeback,format=s2e"
		CMD+=" -net none"
		;;
	s2e|s2e-gdb)
		if [ ${TYPE} == 's2e-gdb' ]; then
			CMD+="truncate -s0 gdb.cfg                   &&"
			CMD+="echo 'handle SIG38 noprint' >> gdb.cfg &&"
			CMD+="echo 'run'                  >> gdb.cfg &&"
			CMD+="gdb -x gdb.cfg --args"
		fi
		CMD+=" \${BUILD}/qemu-release/i386-s2e-softmmu/qemu-system-i386"
		CMD+=" -drive file=\${IMAGE}/image.raw.s2e,cache=writeback,format=s2e"
		CMD+=" -net none"
		CMD+=" -s2e-config-file \${IMAGE}/s2e-config.lua"
		CMD+=" -loadvm ready"
		CMD+=" $*"
		;;
	*)
		echo 'Invalid target type'; exit 1
		;;
esac

# add common qemu options
CMD+=" -m ${QEMU_MEMORY}"
CMD+=" -serial file:serial.txt"
CMD+=" -monitor telnet:${REMOTE_HOST}:${QPORT},server,nowait"
CMD+=" -vnc :${VNC} -usbdevice tablet"

close_qemu()
{
	trap - INT

	expect <<-EOF
		set send_slow {1 .01}
		log_user 0
		spawn telnet ${REMOTE_HOST} ${QPORT}
		expect {
			"(qemu) "
		}
		send -s "q\n\n"
		send_user "\n"
	EOF
}

# VNC connection loop
VNCLOOP=
VNCLOOP+="for i in {0..19}; do"
VNCLOOP+=" echo 'Connecting to VNC...';"
VNCLOOP+=" ssh ${REMOTE_HOST} 'netstat -lnt' | grep $((5900+${VNC})) > /dev/null && break;"
VNCLOOP+=" sleep 0.5;"
VNCLOOP+="done;"
VNCLOOP+="vncviewer ${REMOTE_HOST}:${VNC} >/dev/null 2>&1;"

#
#
#

# start VNC connection loop
bash -c "${VNCLOOP}" &
VNCLOOP_PID=$!

# quit qemu on Ctrl+C
trap close_qemu INT

# launch qemu on remote host
ssh ${REMOTE_HOST} "${CMD}" || true

# kill VNC connection loop
kill ${VNCLOOP_PID} 2>/dev/null || true

